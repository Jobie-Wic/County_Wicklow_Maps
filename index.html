<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planning in County Wicklow</title>

  <!-- Leaflet + plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <!-- Mapbox geocoder (optional) -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>

  <style>
    body{margin:0;font-family:"Segoe UI",sans-serif;background:#f5f5f5}
    header{background:#2c3e50;color:#fff;padding:2rem;text-align:center}
    section{padding:2rem;max-width:1200px;margin:auto}
    #map,#wicklowMap,#heatmap{height:600px;width:100%;margin-top:1rem;border:2px solid #ccc;background:#fff;position:relative}

    /* Legend styling */
    .info.legend{background:#fff;padding:10px;border:1px solid #ccc;font-size:.9em;line-height:1.2em;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,.2)}
    .info.legend .title{font-weight:600;margin-bottom:6px}
    .info.legend .row{display:flex;align-items:center;margin:4px 0}
    .info.legend .swatch{width:12px;height:12px;margin-right:8px;border-radius:2px;border:1px solid #0002}
    .info.legend .ramp{width:160px;height:12px;border:1px solid #0002;margin:6px 0}
    .info.legend .note{font-size:11px;color:#444;margin-top:6px}
    /* Legend embedded inside the layer box */
    .leaflet-control-layers .legend-section{
      border-top:1px solid #ddd;margin-top:8px;padding-top:8px;
    }

    #geocoder-control{position:absolute;top:10px;left:10px;width:320px;z-index:1000;background:#fff;border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,.3);padding:5px}
  </style>
</head>
<body>
<header>
  <h1>Planning Applications in County Wicklow</h1>
</header>

<section>
  <h2>Planning Applications (2016–2024) in County Wicklow</h2>
  <div id="map"></div>
</section>

<section>
  <h2>Focused View of Planning Applications (2016–2024) in Greystones and Delgany</h2>
  <div id="wicklowMap"></div>
</section>

<section>
  <h2>Spatial Distribution of Planning Applications (2016–2024) with GP Locations in County Wicklow</h2>
  <div id="heatmap"></div>
</section>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  /* ====== Config ====== */
  const PLAN_FILE = './Data/plan_app_ww_clean.geojson';
  const GPS_FILE  = './Data/gps_ww_cleaned.geojson';
  const MAPBOX_TOKEN = 'YOUR_MAPBOX_TOKEN'; // <- put a real token here if you want the search box

  /* ====== Helpers ====== */
  function statusColor(status) {
    const s = (status || '').toUpperCase();
    if (s.includes('FINALISED')) return '#8E24AA';
    if (s.includes('APPEALED FINANCIAL')) return '#E53935';
    if (s.includes('APPEALED')) return '#FF9800';
    if (s.includes('NEW APPLICATION')) return '#2196F3';
    if (s.includes('DECISION MADE')) return '#4CAF50';
    return '#FFD700';
  }

  const STATUS_COLORS = {
    "Finalised": "#8E24AA",
    "Appealed Financial": "#E53935",
    "Appealed": "#FF9800",
    "New Application": "#2196F3",
    "Decision Made": "#4CAF50",
    "Other / Unknown": "#FFD700"
  };

  function addStatusLegend(targetMap, title = 'Legend — Application Status') {
    const ctrl = L.control({ position: 'bottomright' });
    ctrl.onAdd = () => {
      const div = L.DomUtil.create('div', 'info legend');
      div.innerHTML = `<div class="title">${title}</div>`;
      for (const [label, color] of Object.entries(STATUS_COLORS)) {
        div.innerHTML += `<div class="row"><span class="swatch" style="background:${color}"></span>${label}</div>`;
      }
      return div;
    };
    ctrl.addTo(targetMap);
    return ctrl;
  }

  function addSimplePointLegend(targetMap, title='Legend', label='Planning applications (points)', color='#FFD700') {
    const ctrl = L.control({ position: 'bottomright' });
    ctrl.onAdd = () => {
      const div = L.DomUtil.create('div', 'info legend');
      div.innerHTML = `<div class="title">${title}</div>
        <div class="row"><span class="swatch" style="background:${color};border:1px solid #0002;border-radius:50%"></span>${label}</div>`;
      return div;
    };
    ctrl.addTo(targetMap);
    return ctrl;
  }

  function addHeatLegendIntoLayers(layerControl) {
    const box = layerControl.getContainer();
    const sec = document.createElement('div');
    sec.className = 'legend-section info legend';
    sec.innerHTML = `
      <div class="title">Legend</div>
      <div>Planning applications (heat)</div>
      <div class="ramp" style="background:linear-gradient(to right,#2b83ba,#abdda4,#ffffbf,#fdae61,#d7191c)"></div>
      <div style="display:flex;justify-content:space-between;font-size:11px;margin-top:-2px;">
        <span>Lower</span><span>Higher</span>
      </div>
      <div class="row" style="margin-top:6px;">
        <span class="swatch" style="background:#fff;border:2px solid #000;border-radius:50%"></span> GP locations (points)
      </div>
      <div class="note">Tip: use the checkboxes above to toggle layers.</div>`;
    box.appendChild(sec);
  }

  /* ====== Main map (zoomed in) ====== */
  const map = L.map('map', { zoomControl:true }).setView([53.0, -6.35], 11);
  const wicklowBounds = L.latLngBounds([52.72, -6.80], [53.35, -5.85]);
  map.setMaxBounds(wicklowBounds.pad(0.25));
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);

  const planAppCluster = L.markerClusterGroup({
    showCoverageOnHover:false, spiderfyOnMaxZoom:true,
    disableClusteringAtZoom:14, maxClusterRadius:60, chunkedLoading:true
  }).addTo(map);

  /* ====== Focus map (zoomed to Greystones/Delgany) ====== */
  const focusMap = L.map('wicklowMap').setView([53.14, -6.07], 13);
  L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
    maxZoom:18,
    attribution:'Map data: © OpenStreetMap contributors, SRTM | Map style: © OpenTopoMap (CC-BY-SA)'
  }).addTo(focusMap);
  const focusBBox = L.latLngBounds([53.095, -6.12], [53.190, -6.020]);

  /* ====== Heat map ====== */
  const heatmap = L.map('heatmap').setView([52.99, -6.36], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(heatmap);
  let planHeat = null, gpLayer = null;

  /* ====== Load planning apps (main + focus) ====== */
  try {
    const planData = await (await fetch(PLAN_FILE)).json();

    // Cluster-friendly markers on the MAIN map
    const planLayer = L.geoJSON(planData, {
      pointToLayer: (f, latlng) => {
        const color = statusColor(f.properties?.application_status);
        const icon = L.divIcon({
          className: 'dot-icon',
          html: `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;
                          border:1px solid #0003;background:${color};"></span>`,
          iconSize: [10,10]
        });
        return L.marker(latlng, { icon });
      }
    });
    planAppCluster.addLayer(planLayer);

    // Points on the FOCUS map (filtered by bbox)
    const focusFeatures = (planData.features || []).filter(f => {
      const c = f.geometry && f.geometry.coordinates;
      return Array.isArray(c) && focusBBox.contains(L.latLng(c[1], c[0]));
    });
    L.geoJSON(
      { type:'FeatureCollection', features: focusFeatures },
      { pointToLayer: (f, latlng) => L.circleMarker(latlng, {
          radius:5, fillColor: statusColor(f.properties?.application_status),
          color:'#000', weight:1.2, opacity:1, fillOpacity:1
        })
      }
    ).addTo(focusMap);
  } catch (e) {
    console.error('Planning load error:', e);
  }

  /* ====== Heat layer data ====== */
  try {
    const planData = await (await fetch(PLAN_FILE)).json();
    const planPoints = [];
    (planData.features || []).forEach(f => {
      const c = f.geometry && f.geometry.coordinates;
      if (Array.isArray(c)) planPoints.push([c[1], c[0]]);
    });
    if (L.heatLayer && planPoints.length) {
      planHeat = L.heatLayer(planPoints, { radius:16, blur:12, maxZoom:16, minOpacity:0.30 }).addTo(heatmap);
    }
  } catch (e) {
    console.error('Heat load error:', e);
  }

  /* ====== GP locations for heatmap ====== */
  try {
    const gpsData = await (await fetch(GPS_FILE)).json();
    const gpsPoints = [];
    (gpsData.features || []).forEach(f => {
      const c = f.geometry && f.geometry.coordinates;
      if (Array.isArray(c)) gpsPoints.push([c[1], c[0]]);
    });
    if (gpsPoints.length) {
      gpLayer = L.layerGroup(
        gpsPoints.map(([lat, lng]) =>
          L.circleMarker([lat, lng], {
            radius:5, color:'#000', weight:1.25,
            fillColor:'#FFF', fillOpacity:0.95
          })
        )
      );
    }
  } catch (e) { console.error('GPS load error:', e); }

  /* ====== Heatmap layer control + merged legend ====== */
  const overlays = {};
  if (planHeat) overlays['Heat – Planning Applications'] = planHeat;
  if (gpLayer) overlays['GP Locations (points)'] = gpLayer;
  const layerCtrl = L.control.layers(null, overlays, { collapsed:false }).addTo(heatmap);
  addHeatLegendIntoLayers(layerCtrl);

  /* ====== Legends (added BEFORE geocoder so they always render) ====== */
  addStatusLegend(map);
  addSimplePointLegend(focusMap);

  /* ====== Optional Geocoder (skip gracefully if no/placeholder token) ====== */
  try {
    if (MAPBOX_TOKEN && MAPBOX_TOKEN !== 'YOUR_MAPBOX_TOKEN') {
      mapboxgl.accessToken = MAPBOX_TOKEN;
      const geocoderDiv = document.createElement('div');
      geocoderDiv.id = 'geocoder-control';
      geocoderDiv.style.margin = '10px';
      document.getElementById('map').appendChild(geocoderDiv);

      const geocoder = new MapboxGeocoder({
        accessToken: MAPBOX_TOKEN,
        mapboxgl,
        marker:false, zoom:13,
        placeholder:'Search Wicklow locations…'
      });
      geocoder.addTo('#geocoder-control');
    } else {
      console.warn('Skipping geocoder: no/placeholder Mapbox token provided.');
    }
  } catch (err) {
    console.warn('Geocoder not initialised:', err);
  }
});
</script>
</body>
</html>
