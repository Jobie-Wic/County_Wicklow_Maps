<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planning in County Wicklow</title>

  <!-- Leaflet + plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <!-- Mapbox geocoder -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>

  <style>
    body{margin:0;font-family:"Segoe UI",sans-serif;background:#f5f5f5}
    header{background:#2c3e50;color:#fff;padding:2rem;text-align:center}
    section{padding:2rem;max-width:1200px;margin:auto}
    #map,#wicklowMap,#heatmap{height:600px;width:100%;margin-top:1rem;border:2px solid #ccc;background:#fff;position:relative}

    .info.legend{background:#fff;padding:10px;border:1px solid #ccc;font-size:.9em;line-height:1.2em;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,.2)}
    .info.legend i{width:12px;height:12px;display:inline-block;margin-right:6px;opacity:.85}

    /* Legend polish */
    .info.legend .title{font-weight:600;margin-bottom:6px}
    .info.legend .row{display:flex;align-items:center;margin:4px 0}
    .info.legend .swatch{width:12px;height:12px;margin-right:8px;border-radius:2px;border:1px solid #0002}
    .info.legend .ramp{width:160px;height:12px;border:1px solid #0002;margin:6px 0}
    .info.legend .note{font-size:11px;color:#444;margin-top:6px}

    /* Legend inserted inside the layer control */
    .leaflet-control-layers .legend-section{
      border-top:1px solid #ddd;
      margin-top:8px;
      padding-top:8px;
    }

    #geocoder-control{position:absolute;top:10px;left:10px;width:320px;z-index:1000;background:#fff;border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,.3);padding:5px}
  </style>
</head>
<body>
<header>
  <h1>Planning Applications in County Wicklow</h1>
</header>

<section>
  <h2>Planning Applications (2016–2024) in County Wicklow</h2>
  <div id="map"></div>
</section>

<section>
  <h2>Focused View of Planning Applications (2016–2024) in Greystones and Delgany</h2>
  <div id="wicklowMap"></div>
</section>

<section>
  <h2>Spatial Distribution of Planning Applications (2016–2024) with GP Locations in County Wicklow</h2>
  <div id="heatmap"></div>
</section>

<script>
document.addEventListener('DOMContentLoaded', async () => {

  /* === Data sources (raw GitHub URLs) === */
  const RAW_BASE = 'https://raw.githubusercontent.com/Jobie-Wic/county_wicklow_maps/main/Data/';
  const PLAN_FILE = RAW_BASE + 'plan_app_ww_clean.geojson';
  const GPS_FILE  = RAW_BASE + 'gps_ww_cleaned.geojson';

  /* Status colour helper */
  function statusColor(status) {
    const s = (status || '').toUpperCase();
    if (s.includes('FINALISED')) return '#8E24AA';
    if (s.includes('APPEALED FINANCIAL')) return '#E53935';
    if (s.includes('APPEALED')) return '#FF9800';
    if (s.includes('NEW APPLICATION')) return '#2196F3';
    if (s.includes('DECISION MADE')) return '#4CAF50';
    return '#FFD700';
  }

  /* Legend helpers */
  const STATUS_COLORS = {
    "Finalised": "#8E24AA",
    "Appealed Financial": "#E53935",
    "Appealed": "#FF9800",
    "New Application": "#2196F3",
    "Decision Made": "#4CAF50",
    "Other / Unknown": "#FFD700"
  };

  function addStatusLegend(targetMap, title = 'Legend') {
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = () => {
      const div = L.DomUtil.create('div', 'info legend');
      div.innerHTML = `<div class="title">${title}</div>`;
      for (const [label, color] of Object.entries(STATUS_COLORS)) {
        div.innerHTML += `<div class="row">
          <span class="swatch" style="background:${color}"></span>${label}
        </div>`;
      }
      return div;
    };
    legend.addTo(targetMap);
    return legend;
  }

  function addSimplePointLegend(targetMap, title = 'Legend', label = 'Planning applications (points)', color = '#FFD700') {
    const ctrl = L.control({ position: 'bottomright' });
    ctrl.onAdd = () => {
      const div = L.DomUtil.create('div', 'info legend');
      div.innerHTML = `<div class="title">${title}</div>`;
      div.innerHTML += `<div class="row">
          <span class="swatch" style="background:${color}; border:1px solid #0002; border-radius:50%"></span>
          ${label}
        </div>`;
      return div;
    };
    ctrl.addTo(targetMap);
    return ctrl;
  }

  function addHeatLegendIntoLayers(layerControl) {
    const container = layerControl.getContainer();
    const sec = document.createElement('div');
    sec.className = 'legend-section info legend';
    sec.innerHTML = `
      <div class="title">Legend</div>
      <div>Planning applications (heat)</div>
      <div class="ramp" style="
          background: linear-gradient(to right,
            #2b83ba, #abdda4, #ffffbf, #fdae61, #d7191c);"></div>
      <div style="display:flex;justify-content:space-between;font-size:11px;margin-top:-2px;">
        <span>Lower</span><span>Higher</span>
      </div>
      <div class="row" style="margin-top:6px;">
        <span class="swatch" style="background:#fff;border:2px solid #000;border-radius:50%"></span>
        GP locations (points)
      </div>
      <div class="note">Tip: use the checkboxes above to toggle layers.</div>
    `;
    container.appendChild(sec);
  }

  /* Optional coordinate helper (toggle if your files are [lat,lon]) */
  const GEOJSON_IS_LATLON = false;
  function toLatLng(c) {
    if (!Array.isArray(c) || isNaN(c[0]) || isNaN(c[1])) return null;
    return GEOJSON_IS_LATLON ? L.latLng(c[0], c[1]) : L.latLng(c[1], c[0]);
  }

  /* Main map */
  const map = L.map('map', { zoomControl:true });
   .setView([53.0, -6.35], 10);
  const wicklowBounds = L.latLngBounds([52.72, -6.80], [53.35, -5.85]);
  map.setMaxBounds(wicklowBounds.pad(0.25));
  map.options.minZoom = map.getZoom();
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);
  L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom:18 }); // available as an alt base
  const planAppCluster = L.markerClusterGroup({
    showCoverageOnHover:false, spiderfyOnMaxZoom:true,
    disableClusteringAtZoom:14, maxClusterRadius:60, chunkedLoading:true
  }).addTo(map);

  /* Focus map */
  const focusMap = L.map('wicklowMap').setView([53.14, -6.07], 13);
  L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
    maxZoom:18,
    attribution:'Map data: © OpenStreetMap contributors, SRTM | Map style: © OpenTopoMap (CC-BY-SA)'
  }).addTo(focusMap);
  const focusBBox = L.latLngBounds([53.095, -6.12], [53.190, -6.020]);

  /* Heat map */
  const heatmap = L.map('heatmap').setView([52.99, -6.36], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(heatmap);
  let planHeat = null, gpLayer = null;

  /* Load data & build layers */
  try {
    const planData = await (await fetch(PLAN_FILE)).json();

    // cluster-friendly markers (divIcon to keep your status colors)
    const planLayer = L.geoJSON(planData, {
      pointToLayer: (f, latlng) => {
        const color = statusColor(f.properties?.application_status);
        const icon = L.divIcon({
          className: 'dot-icon',
          html: `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;
                          border:1px solid #0003;background:${color};"></span>`,
          iconSize: [10,10]
        });
        return L.marker(latlng, { icon });
      },
      onEachFeature: (f, layer) => {
        const p = f.properties || {};
        layer.bindPopup(
          `<strong>${p.development_description || 'No description'}</strong><br>
           ${p.development_address || 'No address'}<br>
           <em>${p.application_status || 'Status unknown'}</em>`
        );
      }
    });
    planAppCluster.addLayer(planLayer);

    // Focus subset
    const focusFeatures = (planData.features || []).filter(f => {
      const ll = toLatLng(f.geometry && f.geometry.coordinates);
      return ll && focusBBox.contains(ll);
    });

    const focusLayer = L.geoJSON(
      { type:'FeatureCollection', features: focusFeatures },
      { pointToLayer: (f, latlng) => L.circleMarker(latlng, {
          radius:5, fillColor: statusColor(f.properties?.application_status),
          color:'#000', weight:1.2, opacity:1, fillOpacity:1
        })
      }
    ).addTo(focusMap);
    
    const fb = focusLayer.getBounds();
    if (fb.isValid()) focusMap.fitBounds(fb, { padding:[20,20] });
    
    // Focus map: simple legend for yellow points
    addSimplePointLegend(focusMap, 'Legend', 'Planning applications (points)', '#FFD700');

  } catch (e) {
    console.error('Planning applications load error:', e);
  }

  /* Planning heat */
  try {
    const planData = await (await fetch(PLAN_FILE)).json();
    const planPoints = [];
    (planData.features || []).forEach(f => {
      const ll = toLatLng(f.geometry && f.geometry.coordinates);
      if (ll) planPoints.push([ll.lat, ll.lng]);
    });
    if (L.heatLayer && planPoints.length) {
      planHeat = L.heatLayer(planPoints, { radius:16, blur:12, maxZoom:16, minOpacity:0.30 }).addTo(heatmap);
    }
  } catch (e) {
    console.error('Planning file load error:', e);
  }

  /* GP locations */
  try {
    const gpsData = await (await fetch(GPS_FILE)).json();
    const gpsPoints = [];
    (gpsData.features || []).forEach(f => {
      const ll = toLatLng(f.geometry && f.geometry.coordinates);
      if (ll) gpsPoints.push([ll.lat, ll.lng]);
    });

    if (gpsPoints.length) {
      if (!heatmap.getPane('gpPane')) {
        heatmap.createPane('gpPane');
        heatmap.getPane('gpPane').style.zIndex = 650;
      }
      gpLayer = L.layerGroup(
        gpsPoints.map(([lat, lng]) =>
          L.circleMarker([lat, lng], {
            pane:'gpPane',
            radius:5,
            color:'#000000',
            weight:1.25,
            fillColor:'#FFFFFF',
            fillOpacity:0.95
          })
        )
      );
    }
  } catch (e) {
    console.error('GPS file load error:', e);
  }

  /* Layer control (heatmap) + merged legend */
  const overlays = {};
  if (planHeat) overlays['Heat – Planning Applications'] = planHeat;
  if (gpLayer)  overlays['GP Locations (points)']        = gpLayer;
  const layerCtrl = L.control.layers(null, overlays, { collapsed:false }).addTo(heatmap);

  // Merge the legend into the SAME box:
  addHeatLegendIntoLayers(layerCtrl);

  /* MAIN map — status legend back in bottom right */
  addStatusLegend(map, 'Legend — Application Status');

  /* Geocoder on main map */
  mapboxgl.accessToken = 'pk.eyJ1IjoicmVhbHRhNzgiLCJhIjoiY204cWE2MWxsMGhwYjJxc2FteGhhczkzYyJ9.PCnUHvs7IX7wtLx0On63kw';
  const geocoderDiv = document.createElement('div'); geocoderDiv.id = 'geocoder-control'; geocoderDiv.style.margin = '10px';
  document.getElementById('map').appendChild(geocoderDiv);
  const geocoder = new MapboxGeocoder({ accessToken: mapboxgl.accessToken, mapboxgl, marker:false, zoom:13, placeholder:'Search Wicklow locations…' });
  geocoder.addTo('#geocoder-control');
});
</script>
</body>
</html>


