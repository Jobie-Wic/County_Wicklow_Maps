<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planning in County Wicklow</title>

  <!-- Leaflet + plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <!-- Mapbox geocoder -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>

  <style>
    body{margin:0;font-family:"Segoe UI",sans-serif;background:#f5f5f5}
    header{background:#2c3e50;color:#fff;padding:2rem;text-align:center}
    section{padding:2rem;max-width:1200px;margin:auto}
    #map,#wicklowMap,#heatmap{height:600px;width:100%;margin-top:1rem;border:2px solid #ccc;background:#fff;position:relative}
    .info.legend{background:#fff;padding:10px;border:1px solid #ccc;font-size:.9em;line-height:1.2em}
    .info.legend i{width:12px;height:12px;display:inline-block;margin-right:6px;opacity:.85}
    #geocoder-control{position:absolute;top:10px;left:10px;width:320px;z-index:1000;background:#fff;border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,.3);padding:5px}
  </style>
</head>
<body>
<header>
  <h1>Planning Applications in County Wicklow</h1>
</header>

<section>
  <h2>Planning Applications (2016–2024) in County Wicklow</h2>
  <div id="map"></div>
</section>

<section>
  <h2>Focused View of Planning Applications (2016–2024) in Greystones and Delgany</h2>
  <div id="wicklowMap"></div>
</section>

<section>
  <h2>Spatial Distribution of Planning Applications (2016–2024) with GP Locations in County Wicklow</h2>
  <div id="heatmap"></div>
</section>

<script>
document.addEventListener('DOMContentLoaded', async () => {

  /* Data files */
  const PLAN_FILE = './Data/plan_app_ww_clean.geojson';
  const GPS_FILE  = './Data/gps_ww_cleaned.geojson';

  /* Status colour helper */
  function statusColor(status) {
    const s = (status || '').toUpperCase();
    if (s.includes('FINALISED')) return '#8E24AA';
    if (s.includes('APPEALED FINANCIAL')) return '#E53935';
    if (s.includes('APPEALED')) return '#FF9800';
    if (s.includes('NEW APPLICATION')) return '#2196F3';
    if (s.includes('DECISION MADE')) return '#4CAF50';
    return '#FFD700';
  }

  /* Main map — start zoomed in */
  const map = L.map('map', { zoomControl:true }).setView([53.0, -6.35], 10);
  const wicklowBounds = L.latLngBounds([52.72, -6.80], [53.35, -5.85]);
  map.setMaxBounds(wicklowBounds.pad(0.25));
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);

  const planAppCluster = L.markerClusterGroup({
    showCoverageOnHover:false, spiderfyOnMaxZoom:true,
    disableClusteringAtZoom:14, maxClusterRadius:60, chunkedLoading:true
  }).addTo(map);

  /* Focus map — fixed zoom */
  const focusMap = L.map('wicklowMap').setView([53.14, -6.07], 13);
  L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
    maxZoom:18,
    attribution:'Map data: © OpenStreetMap contributors, SRTM | Map style: © OpenTopoMap (CC-BY-SA)'
  }).addTo(focusMap);

  const focusBBox = L.latLngBounds([53.095, -6.12], [53.190, -6.020]);

  /* Heat map */
  const heatmap = L.map('heatmap').setView([52.99, -6.36], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(heatmap);
  let planHeat = null, gpLayer = null;

  /* Load planning applications */
  try {
    const planData = await (await fetch(PLAN_FILE)).json();

    const planLayer = L.geoJSON(planData, {
      pointToLayer: (f, latlng) => L.circleMarker(latlng, {
        radius:5,
        fillColor: statusColor(f.properties?.application_status),
        color:'#000', weight:0.8, opacity:1, fillOpacity:0.95
      }),
      onEachFeature: (f, layer) => {
        const p = f.properties || {};
        layer.bindPopup(
          `<strong>${p.development_description || 'No description'}</strong><br>
           ${p.development_address || 'No address'}<br>
           <em>${p.application_status || 'Status unknown'}</em>`
        );
      }
    });
    planAppCluster.addLayer(planLayer);

    const focusFeatures = (planData.features || []).filter(f => {
      const c = f.geometry && f.geometry.coordinates;
      return Array.isArray(c) && focusBBox.contains(L.latLng(c[1], c[0]));
    });

    L.geoJSON(
      { type:'FeatureCollection', features: focusFeatures },
      { pointToLayer: (f, latlng) => L.circleMarker(latlng, {
          radius:5, fillColor: statusColor(f.properties?.application_status),
          color:'#000', weight:1.2, opacity:1, fillOpacity:1
        })
      }
    ).addTo(focusMap);

  } catch (e) {
    console.error('Planning applications load error:', e);
  }

  /* Planning heat */
  try {
    const planData = await (await fetch(PLAN_FILE)).json();
    const planPoints = [];
    (planData.features || []).forEach(f => {
      const c = f.geometry && f.geometry.coordinates;
      if (Array.isArray(c) && !isNaN(c[0]) && !isNaN(c[1])) planPoints.push([c[1], c[0]]);
    });
    if (L.heatLayer && planPoints.length) {
      planHeat = L.heatLayer(planPoints, { radius:16, blur:12, maxZoom:16, minOpacity:0.30 }).addTo(heatmap);
    }
  } catch (e) {
    console.error('Planning file load error:', e);
  }

  /* GP locations */
  try {
    const gpsData = await (await fetch(GPS_FILE)).json();
    const gpsPoints = [];
    (gpsData.features || []).forEach(f => {
      const c = f.geometry && f.geometry.coordinates;
      if (Array.isArray(c) && !isNaN(c[0]) && !isNaN(c[1])) gpsPoints.push([c[1], c[0]]);
    });

    if (gpsPoints.length) {
      if (!heatmap.getPane('gpPane')) {
        heatmap.createPane('gpPane');
        heatmap.getPane('gpPane').style.zIndex = 650;
      }
      gpLayer = L.layerGroup(
        gpsPoints.map(([lat, lng]) =>
          L.circleMarker([lat, lng], {
            pane:'gpPane',
            radius:5,
            color:'#000000',
            weight:1.25,
            fillColor:'#FFFFFF',
            fillOpacity:0.95
          })
        )
      );
    }
  } catch (e) {
    console.error('GPS file load error:', e);
  }

  /* Layer control */
  const overlays = {};
  if (planHeat) overlays['Heat – Planning Applications'] = planHeat;
  if (gpLayer)  overlays['GP Locations (points)']        = gpLayer;
  L.control.layers(null, overlays, { collapsed:false }).addTo(heatmap);

  /* Geocoder */
  mapboxgl.accessToken = 'YOUR_MAPBOX_TOKEN';
  const geocoderDiv = document.createElement('div'); geocoderDiv.id = 'geocoder-control'; geocoderDiv.style.margin = '10px';
  document.getElementById('map').appendChild(geocoderDiv);
  const geocoder = new MapboxGeocoder({ accessToken: mapboxgl.accessToken, mapboxgl, marker:false, zoom:13, placeholder:'Search Wicklow locations…' });
  geocoder.addTo('#geocoder-control');

  /* Status legend (main map) */
  const legend = L.control({ position: 'bottomright' });
  legend.onAdd = () => {
    const div = L.DomUtil.create('div', 'info legend');
    div.innerHTML += '<strong>Legend — Application Status</strong><br>';
    div.innerHTML += '<i style="background:#8E24AA"></i> Finalised<br>';
    div.innerHTML += '<i style="background:#E53935"></i> Appealed Financial<br>';
    div.innerHTML += '<i style="background:#FF9800"></i> Appealed<br>';
    div.innerHTML += '<i style="background:#2196F3"></i> New Application<br>';
    div.innerHTML += '<i style="background:#4CAF50"></i> Decision Made<br>';
    div.innerHTML += '<i style="background:#FFD700"></i> Other / Unknown<br>';
    return div;
  };
  legend.addTo(map);

  /* Legend for focus map */
  const focusLegend = L.control({ position: 'bottomright' });
  focusLegend.onAdd = () => {
    const div = L.DomUtil.create('div', 'info legend');
    div.innerHTML += '<strong>Legend</strong><br>';
    div.innerHTML += '<i style="background:yellow; border:1px solid #000"></i> Planning applications (points)<br>';
    return div;
  };
  focusLegend.addTo(focusMap);

  /* Heatmap legend */
  const heatLegend = L.control({ position: 'bottomleft' });
  heatLegend.onAdd = () => {
    const div = L.DomUtil.create('div', 'info legend');
    div.innerHTML += '<strong>Legend</strong><br>';
    div.innerHTML += 'Planning applications (heat)<br>';
    div.innerHTML += '<div style="height:10px;width:80px;background:linear-gradient(to right, blue, lime, yellow, red);margin:4px 0"></div>';
    div.innerHTML += 'Lower &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Higher<br>';
    div.innerHTML += '<br><i style="background:#fff; border:1px solid #000; border-radius:50%;width:12px;height:12px;display:inline-block;margin-right:6px;"></i> GP locations (points)<br>';
    div.innerHTML += '<em>Tip: use the layer box (top-right) to toggle heat vs. GP points.</em>';
    return div;
  };
  heatLegend.addTo(heatmap);

});
</script>
</body>
</html>

